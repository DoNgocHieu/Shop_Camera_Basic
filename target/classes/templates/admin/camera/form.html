<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title th:text="${camera.id != null ? 'Chỉnh sửa camera' : 'Thêm camera mới'} + ' - Camera'">Quản lý camera - Camera</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Admin Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" th:href="@{/admin}">
                <i class="fas fa-crown me-2"></i>Admin - Camera
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarAdmin" title="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarAdmin">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/admin}">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" th:href="@{/admin/cameras}">
                            <i class="fas fa-camera me-1"></i>Quản lý camera
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/admin/categories}">
                            <i class="fas fa-tags me-1"></i>Quản lý danh mục
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/admin/orders}">
                            <i class="fas fa-shopping-cart me-1"></i>Quản lý đơn hàng
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/}">
                            <i class="fas fa-external-link-alt me-1"></i>Xem website
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/logout}">
                            <i class="fas fa-sign-out-alt me-1"></i>Đăng xuất
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid my-4">
        <div class="row">
            <div class="col-12">
                <!-- Breadcrumb -->
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a th:href="@{/admin}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a th:href="@{/admin/cameras}">Quản lý camera</a></li>
                        <li class="breadcrumb-item active" th:text="${camera.id != null ? 'Chỉnh sửa camera' : 'Thêm camera mới'}">Form</li>
                    </ol>
                </nav>

                <!-- Error Message -->
                <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span th:text="${errorMessage}">Error message</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 th:text="${camera.id != null ? 'Chỉnh sửa camera' : 'Thêm camera mới'}">Form camera</h2>
                    <a th:href="@{/admin/cameras}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Quay lại
                    </a>
                </div>

                <!-- Form -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Thông tin camera</h5>
                            </div>
                            <div class="card-body">
                                <form th:action="@{/admin/cameras/save}" th:object="${camera}" method="post">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <input type="hidden" th:field="*{id}"/>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="name" class="form-label">Tên camera <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" th:field="*{name}" id="name" required>
                                                <div class="invalid-feedback" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="brand" class="form-label">Thương hiệu <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" th:field="*{brand}" id="brand" required>
                                                <div class="invalid-feedback" th:if="${#fields.hasErrors('brand')}" th:errors="*{brand}"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="price" class="form-label">Giá <span class="text-danger">*</span></label>
                                                <input type="number" class="form-control" th:field="*{price}" id="price" min="0" step="1000" required>
                                                <div class="invalid-feedback" th:if="${#fields.hasErrors('price')}" th:errors="*{price}"></div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="category" class="form-label">Danh mục <span class="text-danger">*</span></label>
                                                <select class="form-select" th:field="*{category}" id="category" required>
                                                    <option value="">-- Chọn danh mục --</option>
                                                    <option th:each="cat : ${categories}" 
                                                            th:value="${cat.id}" 
                                                            th:text="${cat.name}"
                                                            th:selected="${camera.category != null and camera.category.id == cat.id}">Category</option>
                                                </select>
                                                <div class="invalid-feedback" th:if="${#fields.hasErrors('category')}" th:errors="*{category}"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="description" class="form-label">Mô tả</label>
                                        <textarea class="form-control" th:field="*{description}" id="description" rows="4"></textarea>
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Hình ảnh camera</label>
                                        
                                        <!-- Tab navigation for image input methods -->
                                        <ul class="nav nav-tabs nav-tabs-sm mb-3" id="imageInputTabs" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="url-tab" data-bs-toggle="tab" data-bs-target="#url-panel" type="button" role="tab" onclick="switchToUrlMode()">
                                                    <i class="fas fa-link me-1"></i>Nhập URL
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-panel" type="button" role="tab" onclick="switchToUploadMode()">
                                                    <i class="fas fa-upload me-1"></i>Upload từ máy
                                                </button>
                                            </li>
                                        </ul>
                                        
                                        <!-- Tab content -->
                                        <div class="tab-content" id="imageInputContent">
                                            <!-- URL Input Panel -->
                                            <div class="tab-pane fade show active" id="url-panel" role="tabpanel">
                                                <input type="text" class="form-control" th:field="*{imageUrl}" id="imageUrl" placeholder="https://example.com/image.jpg hoặc /images/cameras/filename.jpg">
                                                <div class="form-text">Nhập URL đầy đủ từ internet hoặc đường dẫn relative (không bắt buộc)</div>
                                                <div class="invalid-feedback" th:if="${#fields.hasErrors('imageUrl')}" th:errors="*{imageUrl}"></div>
                                                
                                                <!-- Preview button for URL -->
                                                <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="previewUrlImage()">
                                                    <i class="fas fa-eye me-1"></i>Xem trước
                                                </button>
                                            </div>
                                            
                                            <!-- File Upload Panel -->
                                            <div class="tab-pane fade" id="upload-panel" role="tabpanel">
                                                <label for="imageFile" class="form-label">Chọn file ảnh</label>
                                                <input type="file" class="form-control" id="imageFile" accept="image/*" onchange="handleFileUpload(this)" title="Chọn file ảnh từ máy tính" placeholder="Chọn file ảnh">
                                                <div class="form-text">Chọn file ảnh từ máy tính (JPG, PNG, GIF)</div>
                                                
                                                <!-- Upload progress -->
                                                <div class="progress mt-2" id="uploadProgress" style="display: none;">
                                                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Image preview area -->
                                        <div class="mt-3" id="imagePreviewArea">
                                            <div th:if="${camera.imageUrl != null and not #strings.isEmpty(camera.imageUrl)}" class="border rounded p-2">
                                                <img th:src="${camera.imageUrl}" th:alt="${camera.name}" 
                                                     class="img-fluid" style="max-height: 200px;" id="currentImage">
                                                <div class="text-muted small mt-1">Hình ảnh hiện tại</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Debug button (remove in production) -->
                                        <button type="button" class="btn btn-secondary btn-sm mt-2" onclick="debugImageUrl()">
                                            <i class="fas fa-bug"></i> Debug Image URL
                                        </button>
                                    </div>

                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-2"></i>
                                            <span th:text="${camera.id != null ? 'Cập nhật' : 'Thêm mới'}">Lưu</span>
                                        </button>
                                        <a th:href="@{/admin/cameras}" class="btn btn-secondary">
                                            <i class="fas fa-times me-2"></i>Hủy
                                        </a>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <!-- Preview -->
                        <div class="card" th:if="${camera.imageUrl != null and not #strings.isEmpty(camera.imageUrl)}">
                            <div class="card-header">
                                <h6 class="mb-0">Xem trước hình ảnh</h6>
                            </div>
                            <div class="card-body text-center">
                                <img th:src="${camera.imageUrl}" th:alt="${camera.name}" 
                                     class="img-fluid rounded" style="max-height: 200px;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Preview image from URL
        function previewUrlImage() {
            const urlInput = document.getElementById('imageUrl');
            const url = urlInput.value.trim();
            
            if (!url) {
                alert('Vui lòng nhập URL hình ảnh');
                return;
            }
            
            const previewArea = document.getElementById('imagePreviewArea');
            previewArea.innerHTML = `
                <div class="border rounded p-2">
                    <img src="${url}" alt="Preview" class="img-fluid" style="max-height: 200px;" 
                         onload="this.style.display='block'" 
                         onerror="this.parentElement.innerHTML='<div class=\\'text-danger\\'>Không thể tải hình ảnh từ URL này</div>'"
                         style="display: none;">
                    <div class="text-muted small mt-1">Xem trước từ URL</div>
                </div>
            `;
        }
        
        // Handle file upload
        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Vui lòng chọn file hình ảnh');
                input.value = '';
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File quá lớn. Vui lòng chọn file nhỏ hơn 5MB');
                input.value = '';
                return;
            }
            
            // Show upload progress
            const progressContainer = document.getElementById('uploadProgress');
            const progressBar = progressContainer.querySelector('.progress-bar');
            progressContainer.style.display = 'block';
            
            // Create preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewArea = document.getElementById('imagePreviewArea');
                previewArea.innerHTML = `
                    <div class="border rounded p-2">
                        <img src="${e.target.result}" alt="Preview" class="img-fluid" style="max-height: 200px;">
                        <div class="text-muted small mt-1">Xem trước file đã chọn: ${file.name}</div>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
            
            // Simulate upload to cloud storage (you can replace this with actual upload)
            uploadToCloudStorage(file, progressBar, progressContainer);
        }
        
        // Simulate upload to cloud storage (placeholder function)
        function uploadToCloudStorage(file, progressBar, progressContainer) {
            const formData = new FormData();
            formData.append('file', file);
            
            // Get CSRF token
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
            
            const headers = {};
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
            }
            
            fetch('/admin/cameras/upload-image', {
                method: 'POST',
                body: formData,
                headers: headers
            })
            .then(response => {
                if (response.ok) {
                    return response.text();
                }
                throw new Error('Upload failed');
            })
            .then(imageUrl => {
                console.log('Received image URL:', imageUrl); // Debug log
                
                // Clear file input since we're now using uploaded URL
                document.getElementById('imageFile').value = '';
                
                // Set the returned URL to the imageUrl input
                const imageUrlInput = document.getElementById('imageUrl');
                imageUrlInput.value = imageUrl;
                console.log('Set imageUrl input to:', imageUrlInput.value); // Debug log
                
                // Force clear any old preview
                document.getElementById('imageFile').value = '';
                
                // Switch to URL tab to show the result
                const urlTab = new bootstrap.Tab(document.getElementById('url-tab'));
                urlTab.show();
                
                progressContainer.style.display = 'none';
                
                // Update preview with the new URL
                const previewArea = document.getElementById('imagePreviewArea');
                previewArea.innerHTML = `
                    <div class="border rounded p-2">
                        <img src="${imageUrl}" alt="Uploaded image" class="img-fluid" style="max-height: 200px;">
                        <div class="text-success small mt-1">Upload thành công! File: ${file.name}</div>
                        <div class="text-muted small">URL: ${imageUrl}</div>
                    </div>
                `;
                
                alert('Upload ảnh thành công! URL đã được set vào form.');
            })
            .catch(error => {
                console.error('Upload error:', error);
                progressContainer.style.display = 'none';
                alert('Có lỗi xảy ra khi upload file');
            });
        }
        
        // Switch to URL mode - clear upload
        function switchToUrlMode() {
            document.getElementById('imageFile').value = '';
            document.getElementById('uploadProgress').style.display = 'none';
        }
        
        // Switch to Upload mode - clear URL 
        function switchToUploadMode() {
            // Don't clear URL automatically, let user decide
        }
        
        // Auto-preview when URL changes
        document.getElementById('imageUrl').addEventListener('blur', function() {
            if (this.value.trim()) {
                previewUrlImage();
            }
        });
        
        // Debug function to check imageUrl value
        function debugImageUrl() {
            const imageUrlInput = document.getElementById('imageUrl');
            alert('Current imageUrl value: "' + imageUrlInput.value + '"');
            console.log('imageUrl input element:', imageUrlInput);
            console.log('imageUrl value:', imageUrlInput.value);
        }
        
        // Clear upload when user types in URL
        document.getElementById('imageUrl').addEventListener('input', function() {
            if (this.value.trim()) {
                document.getElementById('imageFile').value = '';
            }
        });
        
        // Handle form submission
        document.querySelector('form').addEventListener('submit', function(e) {
            const imageUrlInput = document.getElementById('imageUrl');
            
            // Remove required attribute to prevent validation on hidden input
            imageUrlInput.removeAttribute('required');
            
            // Validate image URL if provided
            const imageUrl = imageUrlInput.value.trim();
            if (imageUrl) {
                // Allow both full URLs and relative paths
                const isValidUrl = imageUrl.startsWith('http://') || 
                                 imageUrl.startsWith('https://') || 
                                 imageUrl.startsWith('/images/');
                
                if (!isValidUrl) {
                    e.preventDefault();
                    alert('URL hình ảnh không hợp lệ. Vui lòng nhập URL đầy đủ (http://...) hoặc đường dẫn bắt đầu với /images/');
                    imageUrlInput.focus();
                    return false;
                }
            }
            
            console.log('Form validation passed. Image URL:', imageUrl);
            // Let form submit normally
        });
        
        // Helper function to handle image URL display consistency
        function getImageUrl(imageUrl) {
            if (!imageUrl) return '/images/default-camera.svg';
            if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) {
                return imageUrl; // Full URL
            }
            if (imageUrl.startsWith('/images/')) {
                return imageUrl; // Already relative path
            }
            return '/images/cameras/' + imageUrl; // Add prefix for relative path
        }
    </script>
</body>
</html>
